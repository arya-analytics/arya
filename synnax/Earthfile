VERSION 0.7
FROM golang:1.23
WORKDIR /synnax

# Upgrade glibc to version 2.38 for numpy installation
RUN apt-get update && apt-get install -y wget build-essential \
    && wget http://ftp.gnu.org/gnu/libc/glibc-2.38.tar.gz \
    && tar -xvf glibc-2.38.tar.gz \
    && cd glibc-2.38 \
    && mkdir build && cd build \
    && ../configure --prefix=/opt/glibc-2.38 \
    && make -j$(nproc) \
    && make install \
    && rm -rf /glibc-2.38* \
    && apt-get clean

# Set the library path to use the upgraded glibc
ENV LD_LIBRARY_PATH="/opt/glibc-2.38/lib:$LD_LIBRARY_PATH"

deps:
    COPY ../freighter/go+source/* /freighter/go
    COPY ../alamos/go+source/* /alamos/go
    COPY ../x/go+source/* /x/go
    COPY ../cesium+source/* /cesium
    COPY ../aspen+source/* /aspen
    COPY ../computron+source/* /computron  # This references the built computron
    COPY go.mod go.sum ./
    RUN go mod download

build:
    FROM +deps
    COPY . .
    ARG driver=true
    IF [ "$driver" = "true" ]
        RUN go build -tags driver -o build/synnax .
    ELSE
        RUN go build -o build/synnax .
    END
    SAVE ARTIFACT build/synnax /synnax AS LOCAL build/synnax

docker:
    ARG tag="latest"
    COPY +build/synnax .
    ENTRYPOINT ["/synnax/synnax", "start"]
    SAVE IMAGE ghcr.io/synnaxlabs/synnax:$tag
